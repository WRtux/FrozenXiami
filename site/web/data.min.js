"use strict";var data={pool:{file:null,indices:null,cache:null},user:null,workers:{loadURL:"worker-load.js",searchURL:"worker-search.js",progress:null}};async function loadPoolIndicesP(e){let t=null;data.workers.progress="读取索引……";try{t=await H.readFileP(e)}catch(e){throw"读取索引失败。"}data.workers.progress="加载索引……";let n=null,a=null,r=new Worker(data.workers.loadURL),o=new Array;return r.addEventListener("message",function(e){var t=e.data;switch(t.event){case"progress":for(var r of t.data)o.push(r);data.workers.progress="加载索引……"+o.length;break;case"load":n();break;case"error":a("加载索引错误："+t.message+(null!=t.code?" @"+H.buildHexadecimal(t.code,2):""))}}),r.postMessage(t,[t]),await new Promise((e,t)=>{[n,a]=[e,t]}),r.terminate(),o}async function loadPoolP(e){let t=null;data.workers.progress="读取文件头……";try{if(e.size<=16)throw void 0;t=await H.readFileP(e.slice(0,16))}catch(e){throw"读取文件头失败。"}let r=new DataView(t);if(3735898442!=r.getUint32(0))throw"文件头错误："+H.buildHexadecimal(r.getUint32(0),8);if(1481441520!=r.getUint32(4))throw"文件头错误："+H.buildHexadecimal(r.getUint32(4),8);var n=r.getUint32(8)*2**32+r.getUint32(12);if(e.size<28+n)throw"文件大小错误。";var a,o=await loadPoolIndicesP(e.slice(16,16+n));data.workers.progress="完成索引……",await H.restP(),t=data.pool.indices={artists:new Array,albums:new Array,songs:new Array,unknown:new Array};for(a of o)null!=a&&("artist"==a.type?t.artists:"album"==a.type?t.albums:"song"==a.type?t.songs:t.unknown).push(a);return data.pool.file=e.slice(28+n),data.pool.cache=new Map,data.workers.progress=null,o}function getIndices(e){return"artist"==e?data.pool.indices.artists:"album"==e?data.pool.indices.albums:"song"==e?data.pool.indices.songs:"unknown"==e?data.pool.indices.unknown:null}async function inflateEntryP(t){if(t.offset+t.length>data.pool.file.size)throw"文件大小错误。";if(data.pool.cache.has(t.offset))return JSON.parse(data.pool.cache.get(t.offset));let r=null;try{r=await H.readFileP(data.pool.file.slice(t.offset,t.offset+t.length));var e=(new TextDecoder).decode(r);return data.pool.cache.set(t.offset,e),1!=arguments[1]&&trimPoolCache(),JSON.parse(e)}catch(e){throw console.warn("Data error",e,t),null!=r?"读取 "+t.name+" 数据失败。":t.name+" 数据存在错误。"}}function inflateEntryA(e,t,r){inflateEntryP(e).then(t,H.filterFunction(r)||toast)}async function inflateEntriesP(e){let t=arguments[1];var r=e.map(e=>inflateEntryP(e,!0).catch(function(e){return H.filterGetFunction(t)(e),null}));return e=await Promise.all(r),trimPoolCache(),e}function inflateEntriesA(e,t,r){inflateEntriesP(e,H.filterFunction(onerror)||toast).then(t)}function trimPoolCache(e){if(!(data.pool.cache.size<=(e=null!=e?e:1e4)))for(var t of data.pool.cache.keys())if(data.pool.cache.delete(t),data.pool.cache.size<=e)break}function queryEntryIndex(e,t,r){e=[(e=getIndices(e)).find(e=>e.id==t),e.find(e=>e.sid==r)];return null!=t&&null!=e[0]?(null!=r&&e[0].sid!=r&&console.warn("SID mismatch",r,e[0]),e[0]):null!=r&&null!=e[1]?(null!=t&&e[1].id!=t&&console.warn("ID mismatch",t,e[1]),e[1]):null}function queryEntryP(e,t,r){r=queryEntryIndex(e,t,r);return null!=r?inflateEntryP(r):null}function searchEntryIndices(e,t){return t=t.map(e=>e.toLowerCase()),getIndices(e).filter(function(e){let r=e.keywords.filter(e=>0<=e.score&&e.string);return r=r.map(e=>e.string.toLowerCase()),t.every(t=>r.some(e=>e.includes(t)))})}async function searchEntryIndicesP(e,t){t=t.map(e=>e.toLowerCase());let r=new Array,n=0,a=performance.now();for(var o of getIndices(e)){let e=o.keywords.filter(e=>0<=e.score&&e.string);e=e.map(e=>e.string.toLowerCase()),t.every(t=>e.some(e=>e.includes(t)))&&r.push(o),400<=++n&&(n=0,100<=performance.now()-a&&(await H.restP(),a=performance.now()))}return r}async function searchEntriesP(e,t,r,n,a){let o=await searchEntryIndicesP(e,t);return r&&(o=sortListEntries(o,t)),null!=n&&null!=a&&(o=o.slice(n,n+a)),inflateEntriesP(o)}function sortListEntries(e,a){a=a.map(e=>e.toLowerCase());let t=e.map(function(e){let n=Array.from(a);var t;let r=0;for(t of e.keywords)0<=t.score&&t.string&&(r+=t.score*function(t){let r=n.filter(e=>t.includes(e));return n=n.filter(e=>!r.includes(e)),r}(t.string.toLowerCase()).length/a.length);return 1e3<=e.counts[0]&&(r+=Math.log10(e.counts[0])-3),1e3<=e.counts[1]&&(r+=.4*(Math.log10(e.counts[1])-3)),{entry:e,score:r}});return t.sort((e,t)=>t.score-e.score).map(e=>e.entry)}data.workers.loadURL=URL.createObjectURL(new Blob([`"use strict";function readEntryIndex(e,s,r){new DataView(s),new TextDecoder;return new Object}function readPoolIndices(s){try{new DataView(s);let e=new Array;for(;;){self.postMessage({event:"progress",data:e});break}self.postMessage({event:"load"})}catch(e){self.postMessage({event:"error",message:e.message,code:null}),console.warn("Error in worker",e)}}self.addEventListener("message",e=>{readPoolIndices(e.data)});`]));